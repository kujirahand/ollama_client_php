<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ollama Chat Client</title>
    <link rel="stylesheet" href="static/css/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 Ollama Chat Client</h1>
            <div class="user-info">
                <span>ようこそ、<span id="username">ゲスト</span>さん</span>
                <div class="ollama-status">
                    <span class="status-indicator" id="statusIndicator"></span>
                    <span>Ollama: <span id="ollamaStatus">接続確認中...</span></span>
                </div>
                <button class="btn btn-secondary" onclick="logout()">ログアウト</button>
            </div>
        </div>

        <!-- Login Screen -->
        <div id="loginScreen" class="content">
            <div class="login-form">
                <h2>ログイン</h2>
                <div id="loginMessage"></div>
                <div class="form-group">
                    <label for="loginUsername">ユーザー名</label>
                    <input type="text" id="loginUsername" value="admin">
                </div>
                <div class="form-group">
                    <label for="loginPassword">パスワード</label>
                    <input type="password" id="loginPassword" value="admin123">
                </div>
                <button class="btn" onclick="login()">ログイン</button>
                <button class="btn btn-secondary" onclick="showRegister()">新規登録</button>
            </div>
        </div>

        <!-- Register Screen -->
        <div id="registerScreen" class="content" style="display: none;">
            <div class="login-form">
                <h2>新規登録</h2>
                <div id="registerMessage"></div>
                <div class="form-group">
                    <label for="registerUsername">ユーザー名</label>
                    <input type="text" id="registerUsername">
                </div>
                <div class="form-group">
                    <label for="registerPassword">パスワード</label>
                    <input type="password" id="registerPassword">
                </div>
                <button class="btn" onclick="register()">登録</button>
                <button class="btn btn-secondary" onclick="showLogin()">ログインに戻る</button>
            </div>
        </div>

        <!-- Main Application -->
        <div id="mainApp" class="content" style="display: none;">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('chat')">💬 チャット</button>
                <button class="nav-tab" onclick="showTab('templates')">📝 テンプレート</button>
                <button class="nav-tab" onclick="showTab('models')">🧠 モデル</button>
                <button class="nav-tab" onclick="showTab('settings')">⚙️ 設定</button>
            </div>

            <!-- Chat Tab -->
            <div id="chatTab" class="tab-content active">
            <div class="chat-controls">
                <select id="modelSelect" onchange="saveSelectedModel(this.value)">
                    <option value="">モデルを選択...</option>
                </select>
                <select id="templateSelect" onchange="insertTemplate()">
                    <option value="">テンプレートを選択...</option>
                </select>
                <label style="display: flex; align-items: center; gap: 5px; white-space: nowrap;">
                    <input type="checkbox" id="streamMode" checked onchange="saveStreamMode(this.checked)">
                    ストリーミング
                </label>
                <button class="btn btn-secondary" onclick="loadChatHistory()">履歴更新</button>
                <button class="btn btn-danger" onclick="clearChat()">チャットクリア</button>
            </div>                <div id="chatArea" class="chat-area">
                    <div class="message assistant">
                        <div class="message-header">🤖 Assistant</div>
                        <div class="message-content">こんにちは！何についてお話ししましょうか？</div>
                    </div>
                </div>

                <div class="input-area">
                    <textarea id="messageInput" placeholder="メッセージを入力してください..." 
                              onkeydown="handleKeyDown(event)"
                              oncompositionstart="handleCompositionStart(event)"
                              oncompositionend="handleCompositionEnd(event)"></textarea>
                    <button class="btn" onclick="sendMessage()" id="sendButton">
                        <span id="sendText">送信</span>
                        <span id="sendLoading" class="loading" style="display: none;"></span>
                    </button>
                </div>
            </div>

            <!-- Templates Tab -->
            <div id="templatesTab" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>プロンプトテンプレート</h3>
                    <button class="btn" onclick="showTemplateForm()">新規作成</button>
                </div>

                <div id="templateForm" style="display: none; margin-bottom: 20px; padding: 20px; background: #f7fafc; border-radius: 8px;">
                    <h4 id="templateFormTitle">新しいテンプレート</h4>
                    <div class="form-group">
                        <label for="templateTitle">タイトル</label>
                        <input type="text" id="templateTitle">
                    </div>
                    <div class="form-group">
                        <label for="templateContent">内容</label>
                        <textarea id="templateContent" rows="5"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="templateModel">対象モデル（オプション）</label>
                        <select id="templateModel">
                            <option value="">すべてのモデル</option>
                        </select>
                    </div>
                    <button class="btn" onclick="saveTemplate()">保存</button>
                    <button class="btn btn-secondary" onclick="cancelTemplate()">キャンセル</button>
                </div>

                <div id="templateList" class="template-list">
                    <!-- テンプレート一覧がここに表示されます -->
                </div>
            </div>

            <!-- Models Tab -->
            <div id="modelsTab" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>利用可能なモデル</h3>
                    <button class="btn" onclick="loadModels()">モデル更新</button>
                </div>

                <div id="modelList" class="model-grid">
                    <!-- モデル一覧がここに表示されます -->
                </div>

                <div id="modelInfo" style="display: none; margin-top: 20px; padding: 20px; background: #f7fafc; border-radius: 8px;">
                    <h4>モデル詳細情報</h4>
                    <pre id="modelInfoContent" style="background: white; padding: 15px; border-radius: 4px; overflow-x: auto;"></pre>
                    <button class="btn btn-secondary" onclick="hideModelInfo()">閉じる</button>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content">
                <h3>設定</h3>
                <div id="settingsMessage"></div>
                
                <div class="form-group">
                    <label for="settingsUsername">ユーザー名</label>
                    <input type="text" id="settingsUsername">
                </div>
                
                <div class="form-group">
                    <label for="settingsDefaultModel">デフォルトモデル</label>
                    <select id="settingsDefaultModel">
                        <option value="">選択してください</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="settingsOllamaUrl">Ollama URL</label>
                    <input type="text" id="settingsOllamaUrl" placeholder="http://localhost:11434">
                </div>
                
                <div class="form-group">
                    <label for="settingsNewPassword">新しいパスワード（変更する場合のみ）</label>
                    <input type="password" id="settingsNewPassword">
                </div>
                
                <button class="btn" onclick="saveSettings()">設定を保存</button>
                <button class="btn btn-secondary" onclick="showInitialSetupFromSettings()">初回設定を再実行</button>
            </div>
        </div>
    </div>

    <!-- 初回設定モーダル -->
    <div id="initialSetupModal" class="modal">
        <div class="modal-content">
            <h2>🎉 ようこそ！</h2>
            <p>初回ログインありがとうございます。<br>
            まず、デフォルトで使用するLLMモデルを選択してください。</p>
            
            <div id="initialSetupMessage"></div>
            
            <div class="form-group">
                <label for="initialDefaultModel">デフォルトモデルを選択</label>
                <select id="initialDefaultModel">
                    <option value="">モデルを選択してください...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="initialOllamaUrl">Ollama URL（必要に応じて変更）</label>
                <input type="text" id="initialOllamaUrl" value="http://localhost:11434">
            </div>
            
            <div class="modal-buttons">
                <button class="btn-modal primary" onclick="saveInitialSetup()">設定を保存</button>
                <button class="btn-modal secondary" onclick="skipInitialSetup()">後で設定</button>
            </div>
        </div>
    </div>

    <script src="static/js/app.js"></script>
</body>
</html>
